<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­—å­—å¤§å†’é™© Â· Word Quest</title>
  <style>
    :root{--bg:#e8f5ff;--card:#ffffff;--accent:#ffcc33;--ok:#4CAF50;--err:#F44336}
    html,body{height:100%;margin:0;font-family:'Comic Sans MS', Helvetica, Arial, sans-serif;background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0;font-size:32px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.3);animation:titleGlow 3s ease-in-out infinite}
    @keyframes titleGlow{0%,100%{text-shadow:2px 2px 4px rgba(0,0,0,0.3)}50%{text-shadow:0 0 20px rgba(255,255,255,0.8),2px 2px 4px rgba(0,0,0,0.3)}}
    .controls{display:flex;gap:10px}
    button{border:0;padding:12px 20px;border-radius:12px;background:linear-gradient(135deg,#4aa3ff,#2196F3);color:#fff;cursor:pointer;font-weight:bold;transition:all 0.3s;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.3)}
    button.secondary{background:linear-gradient(135deg,#9fbffb,#7ba3d8);color:#fff}

    .game-area{display:flex;margin-top:18px;gap:18px}
    .left,.right{background:rgba(255,255,255,0.95);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);backdrop-filter:blur(10px)}
    .left{flex:1;min-height:360px;position:relative}
    .right{width:280px}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .progress{height:16px;background:#e0e0e0;border-radius:10px;overflow:hidden;width:55%;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#FFD700,#FFA500,#FF6347);width:0%;transition:width 0.3s ease;box-shadow:0 0 10px rgba(255,165,0,0.5)}
    .timer{font-weight:700;color:#333;font-size:20px;background:linear-gradient(135deg,#FFD700,#FFA500);padding:8px 16px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.2);animation:timerPulse 1s ease-in-out infinite}
    @keyframes timerPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .card{background:linear-gradient(135deg,#fff 0%,#f0f8ff 100%);padding:16px;border-radius:16px;border:3px solid #ddd;min-height:100px;display:flex;align-items:center;justify-content:center;font-size:24px;position:relative;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.1);font-weight:bold}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.15)}
    .card .missing{display:inline-block;padding:8px 14px;border-radius:10px;background:linear-gradient(135deg,#fff3cd,#ffe5a0);min-width:60px;text-align:center;border:2px dashed #ffc107;animation:blinkBorder 1.5s ease-in-out infinite}
    @keyframes blinkBorder{0%,100%{border-color:#ffc107}50%{border-color:#ff9800}}
    .card.correct{border-color:var(--ok);background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);box-shadow:0 6px 18px rgba(76,175,80,0.3);animation:celebrate 0.6s ease}
    .card.wrong{border-color:var(--err);background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%)}
    @keyframes celebrate{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.05) rotate(-3deg)}75%{transform:scale(1.05) rotate(3deg)}}

    .answers{display:flex;flex-direction:column;gap:14px}
    .answer{padding:14px 18px;border-radius:14px;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);text-align:center;cursor:grab;border:3px solid #FF8C00;font-weight:700;font-size:18px;transition:all 0.3s;box-shadow:0 4px 10px rgba(255,165,0,0.3);color:#333}
    .answer:hover{transform:scale(1.05) rotate(-2deg);box-shadow:0 6px 15px rgba(255,165,0,0.5)}
    .answer:active{cursor:grabbing;transform:scale(0.95)}
    .answer.dragging{opacity:0.6;transform:scale(1.1) rotate(5deg)}
    .answer.used{opacity:0.3;background:linear-gradient(135deg,#ccc 0%,#999 100%);border-color:#666;cursor:not-allowed}

    .footer{display:flex;gap:20px;justify-content:center;margin-top:20px}
    .small{font-size:14px;color:#333;font-weight:600}
    #combo{background:linear-gradient(135deg,#ff6b6b,#ee5a6f);color:#fff;padding:8px 16px;border-radius:10px;box-shadow:0 4px 8px rgba(238,90,111,0.3);animation:comboGlow 2s ease-in-out infinite}
    @keyframes comboGlow{0%,100%{box-shadow:0 4px 8px rgba(238,90,111,0.3)}50%{box-shadow:0 0 20px rgba(238,90,111,0.6)}}
    #roundInfo{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;padding:8px 16px;border-radius:10px;box-shadow:0 4px 8px rgba(0,242,254,0.3)}

    /* animations */
    @keyframes pop {0%{transform:scale(0) rotate(-180deg);opacity:0}50%{transform:scale(1.1) rotate(10deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
    .pop{animation:pop .4s cubic-bezier(0.68, -0.55, 0.265, 1.55)}

    .shake{animation:shake .45s}
    @keyframes shake{0%{transform:translateX(0) rotate(0deg)}10%{transform:translateX(-10px) rotate(-5deg)}20%{transform:translateX(10px) rotate(5deg)}30%{transform:translateX(-10px) rotate(-5deg)}40%{transform:translateX(10px) rotate(5deg)}50%{transform:translateX(-10px) rotate(-5deg)}60%{transform:translateX(10px) rotate(5deg)}70%{transform:translateX(-10px) rotate(-5deg)}80%{transform:translateX(10px) rotate(5deg)}90%{transform:translateX(-10px) rotate(-5deg)}100%{transform:translateX(0) rotate(0deg)}}

    .centered-overlay{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);z-index:1000}
    .dialog{background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%);padding:30px;border-radius:20px;min-width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:dialogPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)}
    @keyframes dialogPop{0%{transform:scale(0.5) rotate(-10deg);opacity:0}100%{transform:scale(1) rotate(0deg);opacity:1}}
    #dialogText{font-size:22px;font-weight:bold;color:#333;text-align:center;margin-bottom:20px}
    .particle-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999}
    .particle{position:absolute;font-size:30px;animation:particleFall 3s ease-out forwards}
    @keyframes particleFall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
    .star{position:absolute;width:10px;height:10px;background:gold;clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);animation:starTwinkle 1s ease-in-out infinite}
    @keyframes starTwinkle{0%,100%{transform:scale(1) rotate(0deg);opacity:1}50%{transform:scale(1.5) rotate(180deg);opacity:0.5}}

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å­—å­—å¤§å†’é™© Â· Word Quest</h1>
      <div class="controls">
        <button id="btnStart">å¼€å§‹æ¸¸æˆ</button>
        <button id="btnReset" class="secondary">é‡ç½®</button>
        <button id="btnSound" class="secondary">ğŸ”Š éŸ³æ•ˆ</button>
        <button id="btnAdmin" class="secondary">è¯åº“ç®¡ç†</button>
      </div>
    </div>

    <div class="game-area">
      <div class="left">
        <div class="topbar">
          <div class="progress" title="è¿›åº¦">
            <i id="progressBar"></i>
          </div>
          <div class="timer" id="timer">--s</div>
        </div>

        <div class="cards" id="cards">
          <!-- 4 cards -->
        </div>

        <div class="footer small">
          <div id="combo">ğŸ”¥ è¿å¯¹ï¼š0</div>
          <div id="roundInfo">ğŸ“ ç¬¬ 0 / 10 è½®</div>
        </div>
      </div>

      <div class="right">
        <h3 style="margin-top:0">ç­”æ¡ˆé€‰æ‹©</h3>
        <div class="answers" id="answers">
          <!-- 4 answers -->
        </div>
        <div style="margin-top:12px" class="small">æ‹–åŠ¨æˆ–ç‚¹å‡»ç­”æ¡ˆåˆ°é¢˜å¡çš„ç©ºç™½å¤„ï¼Œæ—¶é—´åˆ°æˆ–é”™è¯¯åˆ™æœ¬è½®å¤±è´¥ã€‚</div>
      </div>
    </div>

  </div>

  <!-- overlay result -->
  <div id="overlay" style="display:none" class="centered-overlay">
    <div class="dialog" id="dialog">
      <div id="dialogText">é€šå…³ï¼</div>
      <div style="margin-top:12px;text-align:right">
        <button id="nextBtn">ä¸‹ä¸€è½® âœ</button>
      </div>
    </div>
  </div>

  <!-- particle effects -->
  <div id="particles" class="particle-container"></div>

  <script>
    // éŸ³é¢‘ä¸Šä¸‹æ–‡
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;
    
    // éŸ³æ•ˆå‡½æ•°
    function playSound(type) {
      if (!soundEnabled) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      const now = audioContext.currentTime;
      
      switch(type) {
        case 'correct': // æ­£ç¡® - æ¬¢å¿«çš„ä¸Šå‡éŸ³
          oscillator.frequency.setValueAtTime(523, now); // C5
          oscillator.frequency.exponentialRampToValueAtTime(659, now + 0.08); // E5
          oscillator.frequency.exponentialRampToValueAtTime(784, now + 0.16); // G5
          oscillator.frequency.exponentialRampToValueAtTime(1047, now + 0.24); // C6
          gainNode.gain.setValueAtTime(0.3, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.3);
          break;
          
        case 'wrong': // é”™è¯¯ - æŸ”å’Œçš„æç¤ºéŸ³
          oscillator.frequency.setValueAtTime(350, now);
          oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.25);
          gainNode.gain.setValueAtTime(0.25, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.25);
          break;
          
        case 'click': // ç‚¹å‡»
          oscillator.frequency.setValueAtTime(700, now);
          gainNode.gain.setValueAtTime(0.15, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.05);
          break;
          
        case 'select': // é€‰ä¸­å¡ç‰‡
          oscillator.frequency.setValueAtTime(800, now);
          gainNode.gain.setValueAtTime(0.12, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.08);
          break;
          
        case 'complete': // å®Œæˆå…³å¡ - èƒœåˆ©æ—‹å¾‹
          const melody = [
            {freq: 523, time: 0},      // C5
            {freq: 659, time: 0.15},   // E5
            {freq: 784, time: 0.3},    // G5
            {freq: 1047, time: 0.45},  // C6
            {freq: 784, time: 0.6},    // G5
            {freq: 1047, time: 0.75}   // C6
          ];
          melody.forEach(note => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = note.freq;
            gain.gain.setValueAtTime(0.2, now + note.time);
            gain.gain.exponentialRampToValueAtTime(0.01, now + note.time + 0.2);
            osc.start(now + note.time);
            osc.stop(now + note.time + 0.2);
          });
          return;
          
        case 'fail': // å¤±è´¥
          oscillator.frequency.setValueAtTime(300, now);
          oscillator.frequency.exponentialRampToValueAtTime(150, now + 0.4);
          gainNode.gain.setValueAtTime(0.2, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.4);
          break;
          
        case 'victory': // å…¨éƒ¨é€šå…³
          const victoryMelody = [
            {freq: 523, time: 0},
            {freq: 587, time: 0.12},
            {freq: 659, time: 0.24},
            {freq: 698, time: 0.36},
            {freq: 784, time: 0.48},
            {freq: 880, time: 0.6},
            {freq: 988, time: 0.72},
            {freq: 1047, time: 0.84}
          ];
          victoryMelody.forEach(note => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = note.freq;
            gain.gain.setValueAtTime(0.18, now + note.time);
            gain.gain.exponentialRampToValueAtTime(0.01, now + note.time + 0.15);
            osc.start(now + note.time);
            osc.stop(now + note.time + 0.15);
          });
          return;
          
        case 'timer': // æ—¶é—´è­¦å‘Š
          oscillator.frequency.setValueAtTime(880, now);
          gainNode.gain.setValueAtTime(0.2, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          oscillator.type = 'sine';
          oscillator.start(now);
          oscillator.stop(now + 0.1);
          break;
      }
    }
    
    // å…¨å±€çŠ¶æ€
    let rounds = [];
    let curRound = 0;
    let timer = null;
    let timeLeft = 18; // æ¯è½®è®¡æ—¶ç§’æ•°
    let combo = 0;
    let totalRounds = 0;

    const $cards = document.getElementById('cards');
    const $answers = document.getElementById('answers');
    const $timer = document.getElementById('timer');
    const $progressBar = document.getElementById('progressBar');
    const $combo = document.getElementById('combo');
    const $roundInfo = document.getElementById('roundInfo');
    const $overlay = document.getElementById('overlay');
    const $dialogText = document.getElementById('dialogText');
    const $nextBtn = document.getElementById('nextBtn');

    document.getElementById('btnStart').addEventListener('click', () => {
      playSound('click');
      startGame();
    });
    document.getElementById('btnReset').addEventListener('click', () => {
      playSound('click');
      resetGame();
    });
    document.getElementById('nextBtn').addEventListener('click', ()=>{hideOverlay(); nextRound()});

    // Fetch rounds from backend
    async function startGame(){
      try{
        const res = await fetch('/start');
        const data = await res.json();
        rounds = data.rounds || [];
        totalRounds = rounds.length;
        curRound = 0;
        combo = 0;
        renderRound();
      }catch(e){
        alert('æ— æ³•è¿æ¥åç«¯ /start æ¥å£ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨ã€‚');
        console.error(e);
      }
    }

    function resetGame(){
      rounds = [];curRound=0;combo=0;updateUIEmpty();
    }

    function updateUIEmpty(){
      $cards.innerHTML='';$answers.innerHTML='';$timer.textContent='--s';$progressBar.style.width='0%';$roundInfo.textContent='ç¬¬ 0 / 10 è½®';$combo.textContent='ğŸ”¥ è¿å¯¹ï¼š0';
      document.getElementById('particles').innerHTML = '';
    }

    function renderRound(){
      if(curRound>=totalRounds){
        // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
        playSound('victory');
        createCelebration();
        showOverlay('ğŸ† å…¨éƒ¨å®Œæˆï¼æ­å–œä½ é€šå…³ ğŸ‰', false);
        return;
      }
      const round = rounds[curRound];
      $cards.innerHTML=''; $answers.innerHTML='';
      document.getElementById('particles').innerHTML = '';
      $roundInfo.textContent = `ğŸ“ ç¬¬ ${curRound+1} / ${totalRounds} è½®`;

      // render cards
      round.items.forEach((it, idx)=>{
        const div = document.createElement('div');
        div.className='card pop';
        div.dataset.index = idx;
        div.dataset.missing = it.missing;
        div.innerHTML = `<div>${escapeHtml(it.display)}</div>`;
        // allow drop
        div.addEventListener('dragover', (e)=>e.preventDefault());
        div.addEventListener('drop', onCardDrop);
        div.addEventListener('click', ()=>onCardClick(div));
        $cards.appendChild(div);
      });

      // render answers
      round.answers.forEach((ans, idx)=>{
        const a = document.createElement('div');
        a.className='answer pop';
        a.draggable = true;
        a.dataset.value = ans;
        a.textContent = ans || '(ç©º)';
        a.addEventListener('dragstart', onDragStart);
        a.addEventListener('dragend', onDragEnd);
        a.addEventListener('click', ()=>onAnswerClick(a));
        $answers.appendChild(a);
      });

      // reset timer
      startTimer(timeLeft);
      updateProgress();
    }

    function onDragStart(e){
      e.dataTransfer.setData('text/plain', e.target.dataset.value);
      e.target.classList.add('dragging');
    }
    function onDragEnd(e){
      e.target.classList.remove('dragging');
    }

    function onCardDrop(e){
      e.preventDefault();
      const val = e.dataTransfer.getData('text/plain');
      const card = e.currentTarget;
      tryMatch(card, val);
    }

    // ç‚¹å‡»é¢˜å¡åï¼Œå†ç‚¹ç­”æ¡ˆçš„äº¤äº’
    let _selectedCard = null;
    function onCardClick(card){
      // æ’­æ”¾é€‰ä¸­éŸ³æ•ˆ
      playSound('select');
      // é€‰ä¸­å¡ç‰‡
      clearCardSelection();
      _selectedCard = card;
      card.style.boxShadow = '0 8px 18px rgba(0,0,0,0.12)';
    }
    function clearCardSelection(){
      document.querySelectorAll('.card').forEach(c=>c.style.boxShadow='');
      _selectedCard = null;
    }

    function onAnswerClick(answer){
      if(_selectedCard){
        playSound('click');
        tryMatch(_selectedCard, answer.dataset.value, answer);
      }
    }

    function tryMatch(card, val, answerElem=null){
      const missing = card.dataset.missing;
      if(val === missing){
        // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
        playSound('correct');
        // correct
        card.classList.add('correct');
        card.innerHTML = `<div>${escapeHtml(card.textContent.replace('_', val))}</div>`;
        if(answerElem) answerElem.classList.add('used');
        else {
          // find the answer element with this value and mark used
          document.querySelectorAll('.answer').forEach(a=>{ if(a.dataset.value===val) a.classList.add('used') });
        }
        // disable interactions for this card
        card.removeEventListener('click', ()=>onCardClick(card));
        card.removeEventListener('drop', onCardDrop);
        // æ·»åŠ æˆåŠŸç‰¹æ•ˆ
        createSuccessEffect(card);
        createStars(card);
        checkRoundComplete();
      }else{
        // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
        playSound('wrong');
        // wrong
        card.classList.add('wrong');
        card.classList.add('shake');
        createErrorEffect(card);
        setTimeout(()=>{card.classList.remove('shake');card.classList.remove('wrong')},450);
        // fail round
        failRound('âŒ é…å¯¹é”™è¯¯ï¼ŒæŒ‘æˆ˜å¤±è´¥ï¼');
      }
      clearCardSelection();
    }

    // åˆ›å»ºæˆåŠŸç‰¹æ•ˆ
    function createSuccessEffect(element){
      const rect = element.getBoundingClientRect();
      const emojis = ['âœ¨', 'â­', 'ğŸ’«', 'ğŸŒŸ', 'âœ…', 'ğŸ‰'];
      for(let i=0; i<8; i++){
        setTimeout(()=>{
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.textContent = emojis[Math.floor(Math.random()*emojis.length)];
          particle.style.left = rect.left + rect.width/2 + 'px';
          particle.style.top = rect.top + rect.height/2 + 'px';
          particle.style.animationDelay = `${i*0.05}s`;
          document.getElementById('particles').appendChild(particle);
          setTimeout(()=>particle.remove(), 3000);
        }, i*50);
      }
    }

    // åˆ›å»ºæ˜Ÿæ˜Ÿç‰¹æ•ˆ
    function createStars(element){
      const rect = element.getBoundingClientRect();
      for(let i=0; i<12; i++){
        const star = document.createElement('div');
        star.className = 'star';
        const angle = (Math.PI * 2 * i) / 12;
        const distance = 50 + Math.random()*30;
        star.style.left = rect.left + rect.width/2 + Math.cos(angle)*distance + 'px';
        star.style.top = rect.top + rect.height/2 + Math.sin(angle)*distance + 'px';
        star.style.animationDelay = `${i*0.1}s`;
        document.getElementById('particles').appendChild(star);
        setTimeout(()=>star.remove(), 1000);
      }
    }

    // åˆ›å»ºé”™è¯¯ç‰¹æ•ˆ
    function createErrorEffect(element){
      const rect = element.getBoundingClientRect();
      const emojis = ['ğŸ’¥', 'âŒ', 'ğŸ˜¢'];
      for(let i=0; i<5; i++){
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.textContent = emojis[Math.floor(Math.random()*emojis.length)];
        particle.style.left = rect.left + rect.width/2 + 'px';
        particle.style.top = rect.top + rect.height/2 + 'px';
        document.getElementById('particles').appendChild(particle);
        setTimeout(()=>particle.remove(), 3000);
      }
    }

    function checkRoundComplete(){
      const remaining = document.querySelectorAll('.card:not(.correct)').length;
      if(remaining===0){
        // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
        playSound('complete');
        // success
        combo += 1;
        $combo.textContent = `ğŸ”¥ è¿å¯¹ï¼š${combo}`;
        // small reward: +1s if combo multiple of 5
        if(combo>0 && combo%5===0) {
          timeLeft += 1;
          showFloatingText('â±ï¸ +1ç§’å¥–åŠ±ï¼', '#4CAF50');
        }
        // åˆ›å»ºåº†ç¥æ•ˆæœ
        createCelebration();
        showOverlay('ğŸ‰ æœ¬è½®é€šè¿‡ï¼ç»§ç»­ä¸‹ä¸€è½®ï¼Ÿ', true);
        stopTimer();
      }
    }

    function failRound(msg){
      // æ’­æ”¾å¤±è´¥éŸ³æ•ˆ
      playSound('fail');
      combo = 0; $combo.textContent = `ğŸ”¥ è¿å¯¹ï¼š${combo}`;
      // ä¸åœæ­¢è®¡æ—¶å™¨ï¼Œè®©ç”¨æˆ·ç»§ç»­ä½œç­”
      // æ˜¾ç¤ºæç¤ºä¿¡æ¯ä½†ä¸è¿›å…¥ä¸‹ä¸€è½®
      showFloatingText(msg, '#F44336');
    }

    // åˆ›å»ºåº†ç¥æ•ˆæœ
    function createCelebration(){
      const emojis = ['ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ', 'ğŸŒŸ', 'â­', 'âœ¨', 'ğŸ’«', 'ğŸ†'];
      for(let i=0; i<30; i++){
        setTimeout(()=>{
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.textContent = emojis[Math.floor(Math.random()*emojis.length)];
          particle.style.left = Math.random()*window.innerWidth + 'px';
          particle.style.top = '-50px';
          particle.style.animationDuration = (2 + Math.random()*2) + 's';
          document.getElementById('particles').appendChild(particle);
          setTimeout(()=>particle.remove(), 5000);
        }, i*100);
      }
    }

    // æ˜¾ç¤ºæµ®åŠ¨æ–‡å­—
    function showFloatingText(text, color){
      const floatText = document.createElement('div');
      floatText.textContent = text;
      floatText.style.position = 'fixed';
      floatText.style.left = '50%';
      floatText.style.top = '30%';
      floatText.style.transform = 'translateX(-50%)';
      floatText.style.fontSize = '28px';
      floatText.style.fontWeight = 'bold';
      floatText.style.color = color;
      floatText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
      floatText.style.zIndex = '1001';
      floatText.style.animation = 'floatUp 2s ease-out forwards';
      document.body.appendChild(floatText);
      setTimeout(()=>floatText.remove(), 2000);
    }

    // æ·»åŠ æµ®åŠ¨åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = '@keyframes floatUp{0%{transform:translateX(-50%) translateY(0);opacity:1}100%{transform:translateX(-50%) translateY(-100px);opacity:0}}';
    document.head.appendChild(style);

    function startTimer(sec){
      stopTimer();
      let t = sec;
      $timer.textContent = `${t}s`;
      timer = setInterval(()=>{
        t -= 1;
        $timer.textContent = `${t}s`;
        if(t<=3) {
          $timer.style.color = '#F44336';
          playSound('timer'); // æ—¶é—´è­¦å‘ŠéŸ³æ•ˆ
        } else {
          $timer.style.color='#333';
        }
        if(t<=0){
          stopTimer();
          failRound('æ—¶é—´åˆ°ï¼Œæœ¬è½®å¤±è´¥');
        }
      },1000);
    }
    function stopTimer(){ if(timer) clearInterval(timer); timer=null; }

    function updateProgress(){
      const pct = totalRounds===0?0:((curRound)/totalRounds)*100;
      $progressBar.style.width = pct + '%';
    }

    function showOverlay(text, ok){
      $dialogText.textContent = text;
      $overlay.style.display = 'flex';
      $nextBtn.style.display = ok? 'inline-block' : 'none';
    }
    function hideOverlay(){ $overlay.style.display = 'none'; }

    function nextRound(){
      curRound += 1;
      if(curRound>=totalRounds){
        showOverlay('å…¨éƒ¨è½®æ¬¡ç»“æŸï¼Œæ¸¸æˆç»“æŸ ğŸ‰', false);
        // 2ç§’åè‡ªåŠ¨é‡ç½®æ¸¸æˆ
        setTimeout(()=>{
          hideOverlay();
          resetGame();
        }, 2000);
        return;
      }
      renderRound();
      updateProgress();
    }

    // è¾…åŠ©ï¼šè½¬ä¹‰ HTML
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // allow clicking answer to assign to previously selected card
    // also add keyboard accessibility: numbers 1-4 select answers
    document.addEventListener('keydown', (e)=>{
      if(e.key>='1' && e.key<='4'){
        const idx = Number(e.key)-1;
        const ans = document.querySelectorAll('.answer')[idx];
        if(ans){ ans.click(); }
      }
    });

    // éŸ³æ•ˆå¼€å…³æŒ‰é’®
    document.getElementById('btnSound').addEventListener('click', ()=>{
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('btnSound');
      btn.textContent = soundEnabled ? 'ğŸ”Š éŸ³æ•ˆ' : 'ğŸ”‡ é™éŸ³';
      if (soundEnabled) playSound('click');
    });
    
    // è¯åº“ç®¡ç†æŒ‰é’®
    document.getElementById('btnAdmin').addEventListener('click', ()=>{
      playSound('click');
      window.location.href = '/admin';
    });

    // é¡µé¢åŠ è½½åè‡ªåŠ¨å¼€å§‹æ¸¸æˆ
    window.addEventListener('load', ()=>{
      setTimeout(()=>{
        startGame();
      }, 500);
    });

  </script>
</body>
</html>
