<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­—å­—å¤§å†’é™© Â· Word Quest</title>
  <style>
    :root{--bg:#e8f5ff;--card:#ffffff;--accent:#ffcc33;--ok:#4CAF50;--err:#F44336}
    html,body{height:100%;margin:0;font-family:Helvetica, Arial, sans-serif;background:linear-gradient(180deg,#dff3ff,#fff);}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:28px;color:#333}
    .controls{display:flex;gap:10px}
    button{border:0;padding:10px 16px;border-radius:12px;background:#4aa3ff;color:#fff;cursor:pointer}
    button.secondary{background:#9fbffb;color:#123}

    .game-area{display:flex;margin-top:18px;gap:18px}
    .left,.right{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
    .left{flex:1;min-height:360px}
    .right{width:260px}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .progress{height:12px;background:#eee;border-radius:8px;overflow:hidden;width:55%}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#ffcf6b,#ff9a6b);width:0%}
    .timer{font-weight:700;color:#333}

    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .card{background:linear-gradient(180deg,#fff,#f8fdff);padding:12px;border-radius:12px;border:2px solid rgba(0,0,0,0.04);min-height:84px;display:flex;align-items:center;justify-content:center;font-size:22px;position:relative}
    .card .missing{display:inline-block;padding:6px 10px;border-radius:8px;background:#f0f8ff;min-width:48px;text-align:center}
    .card.correct{border-color:var(--ok);box-shadow:0 6px 18px rgba(76,175,80,0.12)}
    .card.wrong{border-color:var(--err)}

    .answers{display:flex;flex-direction:column;gap:12px}
    .answer{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#f7fbff);text-align:center;cursor:pointer;border:2px solid rgba(0,0,0,0.04);font-weight:700}
    .answer.dragging{opacity:0.6}
    .answer.used{opacity:0.4}

    .footer{display:flex;gap:12px;justify-content:center;margin-top:18px}
    .small{font-size:12px;color:#666}

    /* animations */
    @keyframes pop {0%{transform:scale(0.6);opacity:0}100%{transform:scale(1);opacity:1}}
    .pop{animation:pop .25s ease}

    .shake{animation:shake .45s}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}100%{transform:translateX(0)}}

    .centered-overlay{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
    .dialog{background:#fff;padding:22px;border-radius:14px;min-width:320px}

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å­—å­—å¤§å†’é™© Â· Word Quest</h1>
      <div class="controls">
        <button id="btnStart">å¼€å§‹æ¸¸æˆ</button>
        <button id="btnReset" class="secondary">é‡ç½®</button>
        <button id="btnAdmin" class="secondary">è¯åº“ç®¡ç†</button>
      </div>
    </div>

    <div class="game-area">
      <div class="left">
        <div class="topbar">
          <div class="progress" title="è¿›åº¦">
            <i id="progressBar"></i>
          </div>
          <div class="timer" id="timer">--s</div>
        </div>

        <div class="cards" id="cards">
          <!-- 4 cards -->
        </div>

        <div class="footer small">
          <div id="combo">è¿å¯¹ï¼š0</div>
          <div id="roundInfo">ç¬¬ 0 / 10 è½®</div>
        </div>
      </div>

      <div class="right">
        <h3 style="margin-top:0">ç­”æ¡ˆé€‰æ‹©</h3>
        <div class="answers" id="answers">
          <!-- 4 answers -->
        </div>
        <div style="margin-top:12px" class="small">æ‹–åŠ¨æˆ–ç‚¹å‡»ç­”æ¡ˆåˆ°é¢˜å¡çš„ç©ºç™½å¤„ï¼Œæ—¶é—´åˆ°æˆ–é”™è¯¯åˆ™æœ¬è½®å¤±è´¥ã€‚</div>
      </div>
    </div>

  </div>

  <!-- overlay result -->
  <div id="overlay" style="display:none" class="centered-overlay">
    <div class="dialog" id="dialog">
      <div id="dialogText">é€šå…³ï¼</div>
      <div style="margin-top:12px;text-align:right">
        <button id="nextBtn">ä¸‹ä¸€è½®</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let rounds = [];
    let curRound = 0;
    let timer = null;
    let timeLeft = 18; // æ¯è½®è®¡æ—¶ç§’æ•°
    let combo = 0;
    let totalRounds = 0;

    const $cards = document.getElementById('cards');
    const $answers = document.getElementById('answers');
    const $timer = document.getElementById('timer');
    const $progressBar = document.getElementById('progressBar');
    const $combo = document.getElementById('combo');
    const $roundInfo = document.getElementById('roundInfo');
    const $overlay = document.getElementById('overlay');
    const $dialogText = document.getElementById('dialogText');
    const $nextBtn = document.getElementById('nextBtn');

    document.getElementById('btnStart').addEventListener('click', startGame);
    document.getElementById('btnReset').addEventListener('click', resetGame);
    document.getElementById('nextBtn').addEventListener('click', ()=>{hideOverlay(); nextRound()});

    // Fetch rounds from backend
    async function startGame(){
      try{
        const res = await fetch('/start');
        const data = await res.json();
        rounds = data.rounds || [];
        totalRounds = rounds.length;
        curRound = 0;
        combo = 0;
        renderRound();
      }catch(e){
        alert('æ— æ³•è¿æ¥åç«¯ /start æ¥å£ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨ã€‚');
        console.error(e);
      }
    }

    function resetGame(){
      rounds = [];curRound=0;combo=0;updateUIEmpty();
    }

    function updateUIEmpty(){
      $cards.innerHTML='';$answers.innerHTML='';$timer.textContent='--s';$progressBar.style.width='0%';$roundInfo.textContent='ç¬¬ 0 / 10 è½®';$combo.textContent='è¿å¯¹ï¼š0';
    }

    function renderRound(){
      if(curRound>=totalRounds){
        showOverlay('å…¨éƒ¨å®Œæˆï¼æ­å–œä½  ğŸ‰', false);
        return;
      }
      const round = rounds[curRound];
      $cards.innerHTML=''; $answers.innerHTML='';
      $roundInfo.textContent = `ç¬¬ ${curRound+1} / ${totalRounds} è½®`;

      // render cards
      round.items.forEach((it, idx)=>{
        const div = document.createElement('div');
        div.className='card pop';
        div.dataset.index = idx;
        div.dataset.missing = it.missing;
        div.innerHTML = `<div>${escapeHtml(it.display)}</div>`;
        // allow drop
        div.addEventListener('dragover', (e)=>e.preventDefault());
        div.addEventListener('drop', onCardDrop);
        div.addEventListener('click', ()=>onCardClick(div));
        $cards.appendChild(div);
      });

      // render answers
      round.answers.forEach((ans, idx)=>{
        const a = document.createElement('div');
        a.className='answer pop';
        a.draggable = true;
        a.dataset.value = ans;
        a.textContent = ans || '(ç©º)';
        a.addEventListener('dragstart', onDragStart);
        a.addEventListener('dragend', onDragEnd);
        a.addEventListener('click', ()=>onAnswerClick(a));
        $answers.appendChild(a);
      });

      // reset timer
      startTimer(timeLeft);
      updateProgress();
    }

    function onDragStart(e){
      e.dataTransfer.setData('text/plain', e.target.dataset.value);
      e.target.classList.add('dragging');
    }
    function onDragEnd(e){
      e.target.classList.remove('dragging');
    }

    function onCardDrop(e){
      e.preventDefault();
      const val = e.dataTransfer.getData('text/plain');
      const card = e.currentTarget;
      tryMatch(card, val);
    }

    // ç‚¹å‡»é¢˜å¡åï¼Œå†ç‚¹ç­”æ¡ˆçš„äº¤äº’
    let _selectedCard = null;
    function onCardClick(card){
      // é€‰ä¸­å¡ç‰‡
      clearCardSelection();
      _selectedCard = card;
      card.style.boxShadow = '0 8px 18px rgba(0,0,0,0.12)';
    }
    function clearCardSelection(){
      document.querySelectorAll('.card').forEach(c=>c.style.boxShadow='');
      _selectedCard = null;
    }

    function onAnswerClick(answer){
      if(_selectedCard){
        tryMatch(_selectedCard, answer.dataset.value, answer);
      }
    }

    function tryMatch(card, val, answerElem=null){
      const missing = card.dataset.missing;
      if(val === missing){
        // correct
        card.classList.add('correct');
        card.innerHTML = `<div>${escapeHtml(card.textContent.replace('_', val))}</div>`;
        if(answerElem) answerElem.classList.add('used');
        else {
          // find the answer element with this value and mark used
          document.querySelectorAll('.answer').forEach(a=>{ if(a.dataset.value===val) a.classList.add('used') });
        }
        // disable interactions for this card
        card.removeEventListener('click', ()=>onCardClick(card));
        card.removeEventListener('drop', onCardDrop);
        checkRoundComplete();
      }else{
        // wrong
        card.classList.add('wrong');
        card.classList.add('shake');
        setTimeout(()=>{card.classList.remove('shake');card.classList.remove('wrong')},450);
        // fail round
        failRound('é…å¯¹é”™è¯¯ï¼ŒæŒ‘æˆ˜å¤±è´¥ï¼');
      }
      clearCardSelection();
    }

    function checkRoundComplete(){
      const remaining = document.querySelectorAll('.card:not(.correct)').length;
      if(remaining===0){
        // success
        combo += 1;
        $combo.textContent = `è¿å¯¹ï¼š${combo}`;
        // small reward: +1s if combo multiple of 5
        if(combo>0 && combo%5===0) timeLeft += 1;
        showOverlay('æœ¬è½®é€šè¿‡ï¼ç»§ç»­ä¸‹ä¸€è½®ï¼Ÿ', true);
        stopTimer();
      }
    }

    function failRound(msg){
      combo = 0; $combo.textContent = `è¿å¯¹ï¼š${combo}`;
      stopTimer();
      showOverlay(msg, false);
      // 2ç§’åè‡ªåŠ¨é‡ç½®æ¸¸æˆ
      setTimeout(()=>{
        hideOverlay();
        resetGame();
      }, 2000);
    }

    function startTimer(sec){
      stopTimer();
      let t = sec;
      $timer.textContent = `${t}s`;
      timer = setInterval(()=>{
        t -= 1;
        $timer.textContent = `${t}s`;
        if(t<=3) $timer.style.color = '#F44336'; else $timer.style.color='#333';
        if(t<=0){
          stopTimer();
          failRound('æ—¶é—´åˆ°ï¼Œæœ¬è½®å¤±è´¥');
        }
      },1000);
    }
    function stopTimer(){ if(timer) clearInterval(timer); timer=null; }

    function updateProgress(){
      const pct = totalRounds===0?0:((curRound)/totalRounds)*100;
      $progressBar.style.width = pct + '%';
    }

    function showOverlay(text, ok){
      $dialogText.textContent = text;
      $overlay.style.display = 'flex';
      $nextBtn.style.display = ok? 'inline-block' : 'none';
    }
    function hideOverlay(){ $overlay.style.display = 'none'; }

    function nextRound(){
      curRound += 1;
      if(curRound>=totalRounds){
        showOverlay('å…¨éƒ¨è½®æ¬¡ç»“æŸï¼Œæ¸¸æˆç»“æŸ ğŸ‰', false);
        // 2ç§’åè‡ªåŠ¨é‡ç½®æ¸¸æˆ
        setTimeout(()=>{
          hideOverlay();
          resetGame();
        }, 2000);
        return;
      }
      renderRound();
      updateProgress();
    }

    // è¾…åŠ©ï¼šè½¬ä¹‰ HTML
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // allow clicking answer to assign to previously selected card
    // also add keyboard accessibility: numbers 1-4 select answers
    document.addEventListener('keydown', (e)=>{
      if(e.key>='1' && e.key<='4'){
        const idx = Number(e.key)-1;
        const ans = document.querySelectorAll('.answer')[idx];
        if(ans){ ans.click(); }
      }
    });

    // è¯åº“ç®¡ç†æŒ‰é’®
    document.getElementById('btnAdmin').addEventListener('click', ()=>{
      window.location.href = '/admin';
    });

  </script>
</body>
</html>
