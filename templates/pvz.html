<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æé¾™æ™ºç›Šç­”é¢˜æ¸¸æˆ Demo</title>
<style>
    body {
        margin: 0;
        font-family: "Comic Sans MS", sans-serif;
        background: #b9e8ff;
        overflow: hidden;
    }
    #game {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: url('/static/images/pvz/backgroud.png');
        background-size: cover;
        background-position: center;
        overflow: hidden;
    }
    #game::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: inherit;
        opacity: 0.3;
        z-index: 0;
    }
    .monster {
        position: absolute;
        width: auto;
        height: 100vh;
        transition: transform 0.2s;
        z-index: 10;
    }
    @keyframes fly {
        from { transform: translateX(-50px) translateY(0); opacity: 1; }
        to { transform: translateX(100px) translateY(-50px) rotate(90deg); opacity: 0; }
    }
    @keyframes explode {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5) rotate(10deg); opacity: 0.7; }
        100% { transform: scale(2) rotate(20deg); opacity: 0; }
    }
    #answers {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 20;
    }
    .ans-btn {
        padding: 15px 25px;
        background: #fff;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        border: 3px solid #333;
        transition: 0.2s;
    }
    .ans-btn:hover {
        background: #ffe08a;
    }
    .bullet {
        position: absolute;
        width: 60px;
        height: 60px;
        background: url('/static/images/pvz/bullet.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 15;
        transition: none;
        pointer-events: none;
        border: 2px solid red;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    #questionBox {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        background: rgba(255,255,255,0.8);
        padding: 10px 30px;
        border-radius: 15px;
        border: 3px solid #444;
        z-index: 20;
    }
    #resetBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 15px 30px;
        background: #4CAF50;
        color: white;
        border: 3px solid #2e7d32;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        transition: 0.2s;
        z-index: 20;
    }
    #resetBtn:hover {
        background: #66bb6a;
        transform: scale(1.05);
    }
</style>
</head>
<body>

<div id="game">
    <div id="questionBox"></div>
    <div id="answers"></div>
    <button id="resetBtn">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
</div>

<script>
const monsters = [
    { img: "/static/images/pvz/monster1.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
    { img: "/static/images/pvz/monster2.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
    { img: "/static/images/pvz/monster3.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
];

let currentMonster = null;
let monsterX = window.innerWidth - 150;
let moving = true;

// ç”Ÿæˆéšæœºé¢˜åº“ï¼ˆ100ä»¥å†…åŠ å‡æ³•ï¼‰
function generateQuestions(count = 10) {
    const newQuestions = [];
    for (let i = 0; i < count; i++) {
        const isAddition = Math.random() > 0.5;
        let num1, num2, answer;
        
        if (isAddition) {
            num1 = Math.floor(Math.random() * 90) + 1; // 1-90
            num2 = Math.floor(Math.random() * (100 - num1)); // ç¡®ä¿å’Œä¸è¶…è¿‡100
            answer = num1 + num2;
        } else {
            num1 = Math.floor(Math.random() * 100) + 1; // 1-100
            num2 = Math.floor(Math.random() * num1); // ç¡®ä¿ç»“æœä¸ºæ­£æ•°
            answer = num1 - num2;
        }
        
        const operator = isAddition ? "+" : "-";
        const question = `${num1} ${operator} ${num2} = ?`;
        
        // ç”Ÿæˆ3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const wrongAnswers = new Set();
        while (wrongAnswers.size < 3) {
            let wrong = answer + Math.floor(Math.random() * 21) - 10; // Â±10èŒƒå›´å†…
            if (wrong !== answer && wrong >= 0 && wrong <= 100) {
                wrongAnswers.add(wrong);
            }
        }
        
        // åˆå¹¶ç­”æ¡ˆå¹¶æ‰“ä¹±
        const allAnswers = [answer, ...Array.from(wrongAnswers)];
        const shuffled = allAnswers.sort(() => Math.random() - 0.5);
        const rightIndex = shuffled.indexOf(answer);
        
        newQuestions.push({
            q: question,
            opts: shuffled.map(String),
            right: rightIndex
        });
    }
    return newQuestions;
}

let questions = generateQuestions(10);
let qi = 0;

function loadQuestion() {
    const qData = questions[qi];
    document.getElementById("questionBox").innerText = qData.q;

    let answers = document.getElementById("answers");
    answers.innerHTML = "";

    qData.opts.forEach((op, idx) => {
        let btn = document.createElement("div");
        btn.className = "ans-btn";
        btn.innerText = op;
        btn.onclick = () => checkAnswer(idx);
        answers.appendChild(btn);
    });
}

// åˆ›å»ºæ€ªå…½
function spawnMonster() {
    let m = monsters[Math.floor(Math.random() * monsters.length)];

    const img = document.createElement("img");
    img.src = m.img;
    img.className = "monster";
    img.style.left = monsterX + "px";
    img.style.top = "0";
    img.style.bottom = "0";

    img.dataset.speed = m.speed;

    document.getElementById("game").appendChild(img);
    currentMonster = img;

    moving = true;
    requestAnimationFrame(moveMonster);
}

// ç§»åŠ¨æ€ªå…½
function moveMonster() {
    if (!moving || !currentMonster) return;

    monsterX -= currentMonster.dataset.speed;

    currentMonster.style.left = monsterX + "px";

    if (monsterX < 80) {
        alert("âŒ æ¸¸æˆå¤±è´¥ï¼šæé¾™åƒæ‰äº†è›‹ï¼");
        location.reload();
        return;
    }

    requestAnimationFrame(moveMonster);
}

// å‘å°„å­å¼¹
function fireBullet(target, startX, startY) {
    const bullet = document.createElement("div");
    bullet.className = "bullet";

    // è°ƒæ•´èµ·å§‹ä½ç½®ï¼Œè®©å­å¼¹å±…ä¸­
    bullet.style.left = (startX - 30) + "px"; // å‡å»å­å¼¹å®½åº¦çš„ä¸€åŠ
    bullet.style.top = (startY - 30) + "px"; // å‡å»å­å¼¹é«˜åº¦çš„ä¸€åŠ

    document.getElementById("game").appendChild(bullet);

    console.log("å­å¼¹åˆ›å»º:", { startX, startY });

    // è·å–æ€ªå…½çš„ä½ç½®
    const monsterRect = target.getBoundingClientRect();
    const targetX = monsterRect.left + monsterRect.width / 2 - 30; // å±…ä¸­
    const targetY = monsterRect.top + monsterRect.height / 2 - 30; // å±…ä¸­

    console.log("ç›®æ ‡ä½ç½®:", { targetX, targetY });

    const distanceX = targetX - (startX - 30);
    const distanceY = targetY - (startY - 30);
    const duration = 120; // 120å¸§ï¼Œçº¦2ç§’ï¼Œè®©ç§»åŠ¨æ›´å®¹æ˜“çœ‹åˆ°
    const stepX = distanceX / duration;
    const stepY = distanceY / duration;

    let frame = 0;
    let bx = startX - 30;
    let by = startY - 30;

    const timer = setInterval(() => {
        frame++;
        bx += stepX;
        by += stepY;
        bullet.style.left = bx + "px";
        bullet.style.top = by + "px";

        if (frame % 20 === 0) {
            console.log("å­å¼¹ä½ç½®:", { bx, by, frame });
        }

        // åˆ°è¾¾ç›®æ ‡ä½ç½®æˆ–è¶…è¿‡æ—¶é—´
        if (frame >= duration) {
            clearInterval(timer);
            console.log("å­å¼¹åˆ°è¾¾ç›®æ ‡");
            bullet.remove();
            killMonster(target);
        }

    }, 16); // çº¦60fps
}

// å‡»æ€æ€ªå…½
function killMonster(monster) {
    moving = false;

    monster.style.animation = "explode 0.6s forwards";

    setTimeout(() => monster.remove(), 500);

    setTimeout(() => nextQuestion(), 600);
}

function checkAnswer(idx) {
    const qData = questions[qi];
    if (idx === qData.right) {
        // è·å–ç‚¹å‡»æŒ‰é’®çš„ä½ç½®
        const answerBtns = document.querySelectorAll('.ans-btn');
        const clickedBtn = answerBtns[idx];
        const btnRect = clickedBtn.getBoundingClientRect();

        fireBullet(currentMonster, btnRect.left, btnRect.top + btnRect.height / 2);
    } else {
        // é”™è¯¯åˆ™æ€ªå…½åŠ é€Ÿ
        currentMonster.dataset.speed *= 1.5;
    }
}

function nextQuestion() {
    qi++;
    if (qi >= questions.length) {
        alert("ğŸ‰ æ­å–œå…¨éƒ¨ç­”å¯¹ï¼");
        resetGame();
        return;
    }
    monsterX = window.innerWidth - 150;
    loadQuestion();
    spawnMonster();
}

// é‡ç½®æ¸¸æˆ
function resetGame() {
    // æ¸…é™¤å½“å‰æ€ªå…½
    if (currentMonster) {
        currentMonster.remove();
        currentMonster = null;
    }
    
    // æ¸…é™¤æ‰€æœ‰å­å¼¹
    document.querySelectorAll('.bullet').forEach(b => b.remove());
    
    // é‡æ–°ç”Ÿæˆé¢˜åº“
    questions = generateQuestions(10);
    qi = 0;
    monsterX = window.innerWidth - 150;
    moving = false;
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    loadQuestion();
    spawnMonster();
}

// åˆå§‹åŒ–
loadQuestion();
spawnMonster();

// ç»‘å®šé‡ç½®æŒ‰é’®
document.getElementById("resetBtn").onclick = () => {
    if (confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå¹¶ç”Ÿæˆæ–°é¢˜ç›®å—ï¼Ÿ")) {
        resetGame();
    }
};
</script>
</body>
</html>
