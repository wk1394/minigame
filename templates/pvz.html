<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æé¾™æ™ºç›Šç­”é¢˜æ¸¸æˆ Demo</title>
<style>
    body {
        margin: 0;
        font-family: "Comic Sans MS", sans-serif;
        background: linear-gradient(135deg, #b9e8ff 0%, #87CEEB 100%);
        overflow: hidden;
    }
    #game {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: url('/static/images/pvz/backgroud.png');
        background-size: cover;
        background-position: center;
        overflow: hidden;
    }
    #game::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: inherit;
        opacity: 0.3;
        z-index: 0;
    }
    .monster {
        position: absolute;
        width: auto;
        height: 100vh;
        transition: transform 0.2s;
        z-index: 10;
    }
    @keyframes fly {
        from { transform: translateX(-50px) translateY(0); opacity: 1; }
        to { transform: translateX(100px) translateY(-50px) rotate(90deg); opacity: 0; }
    }
    @keyframes explode {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5) rotate(10deg); opacity: 0.7; }
        100% { transform: scale(2) rotate(20deg); opacity: 0; }
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0) rotate(0deg); }
        10% { transform: translateX(-5px) rotate(-2deg); }
        20% { transform: translateX(5px) rotate(2deg); }
        30% { transform: translateX(-5px) rotate(-2deg); }
        40% { transform: translateX(5px) rotate(2deg); }
        50% { transform: translateX(-5px) rotate(-2deg); }
        60% { transform: translateX(5px) rotate(2deg); }
        70% { transform: translateX(-5px) rotate(-2deg); }
        80% { transform: translateX(5px) rotate(2deg); }
        90% { transform: translateX(-5px) rotate(-2deg); }
    }
    @keyframes cheer {
        0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
        25% { transform: translateY(-20px) scale(1.1) rotate(-5deg); }
        50% { transform: translateY(-10px) scale(1.05) rotate(5deg); }
        75% { transform: translateY(-15px) scale(1.08) rotate(-3deg); }
    }
    @keyframes fear {
        0% { transform: scale(1); }
        25% { transform: scale(0.9) translateY(5px); }
        50% { transform: scale(0.85) translateY(8px); }
        75% { transform: scale(0.9) translateY(5px); }
        100% { transform: scale(1); }
    }
    @keyframes cry {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-10deg); }
        75% { transform: rotate(10deg); }
    }
    @keyframes eaten {
        0% { transform: scale(1) rotate(0deg); opacity: 1; }
        20% { transform: scale(0.9) rotate(-15deg); opacity: 0.9; }
        40% { transform: scale(0.7) rotate(15deg); opacity: 0.7; }
        60% { transform: scale(0.5) rotate(-30deg); opacity: 0.5; }
        80% { transform: scale(0.3) rotate(30deg); opacity: 0.3; }
        100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }
    #playerDino {
        position: absolute;
        left: 100px;
        bottom: 30%;
        font-size: 120px;
        z-index: 25;
        animation: shake 2s infinite ease-in-out;
        transition: all 0.3s;
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
    }
    #playerDino.cheer {
        animation: cheer 0.8s ease-in-out 3;
    }
    #playerDino.fear {
        animation: fear 0.3s ease-in-out infinite;
    }
    #playerDino.cry {
        animation: cry 0.5s ease-in-out infinite;
    }
    #playerDino.eaten {
        animation: eaten 1.5s ease-in-out forwards;
    }
    .emotion {
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 40px;
        animation: emotionPop 1s ease-out;
    }
    @keyframes emotionPop {
        0% { transform: translateX(-50%) scale(0); opacity: 0; }
        50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
        100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
    #answers {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 20;
    }
    .ans-btn {
        padding: 15px 25px;
        background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        border: 3px solid #333;
        transition: all 0.3s;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        font-weight: bold;
    }
    .ans-btn:hover {
        background: linear-gradient(135deg, #ffe08a 0%, #ffd700 100%);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .ans-btn:active {
        transform: translateY(0) scale(0.98);
    }
    .bullet {
        position: absolute;
        width: 60px;
        height: 60px;
        background: url('/static/images/pvz/bullet.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 15;
        transition: none;
        pointer-events: none;
        border: 2px solid red;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    #questionBox {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,240,240,0.95) 100%);
        padding: 15px 40px;
        border-radius: 20px;
        border: 4px solid #333;
        z-index: 20;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        font-weight: bold;
        color: #333;
    }
    #resetBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 15px 30px;
        background: #4CAF50;
        color: white;
        border: 3px solid #2e7d32;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        transition: 0.2s;
        z-index: 20;
    }
    #resetBtn:hover {
        background: #66bb6a;
        transform: scale(1.05);
    }
    #scoreDisplay {
        position: absolute;
        top: 90px;
        right: 20px;
        background: linear-gradient(135deg, rgba(255,215,0,0.9) 0%, rgba(255,165,0,0.9) 100%);
        padding: 15px 30px;
        border-radius: 15px;
        border: 3px solid #ff8c00;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        z-index: 20;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .fire-effect {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 30;
    }
    .firework {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: fireworkAnim 1s ease-out forwards;
    }
    @keyframes fireworkAnim {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    #soundToggle {
        position: absolute;
        top: 90px;
        right: 20px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        color: white;
        border: 3px solid #E74C3C;
        border-radius: 12px;
        font-size: 18px;
        cursor: pointer;
        transition: 0.2s;
        z-index: 20;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    #soundToggle:hover {
        background: linear-gradient(135deg, #FF8E53, #FF6B6B);
        transform: scale(1.05);
    }
</style>
</head>
<body>

<div id="game">
    <div id="questionBox"></div>
    <div id="playerDino">ğŸ¦–</div>
    <div id="answers"></div>
    <button id="resetBtn">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
    <button id="soundToggle">ğŸ”Š éŸ³æ•ˆ</button>
    <div id="scoreDisplay">â­ å¾—åˆ†: <span id="score">0</span></div>
    <div class="fire-effect" id="fireEffect"></div>
</div>

<script>
// éŸ³é¢‘ä¸Šä¸‹æ–‡
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
let soundEnabled = true;

// éŸ³æ•ˆå‡½æ•°
function playSound(type) {
    if (!soundEnabled) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    const now = audioContext.currentTime;
    
    switch(type) {
        case 'correct': // æ­£ç¡®ç­”æ¡ˆ - æ¬¢å¿«çš„ä¸Šå‡éŸ³
            oscillator.frequency.setValueAtTime(523, now); // C5
            oscillator.frequency.exponentialRampToValueAtTime(784, now + 0.1); // G5
            oscillator.frequency.exponentialRampToValueAtTime(1047, now + 0.2); // C6
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            break;
            
        case 'wrong': // é”™è¯¯ç­”æ¡ˆ - ä½æ²‰çš„ä¸‹é™éŸ³
            oscillator.frequency.setValueAtTime(400, now);
            oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            oscillator.type = 'sawtooth';
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            break;
            
        case 'shoot': // å‘å°„å­å¼¹ - çŸ­ä¿ƒçš„å‘å°„éŸ³
            oscillator.frequency.setValueAtTime(800, now);
            oscillator.frequency.exponentialRampToValueAtTime(400, now + 0.1);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            oscillator.type = 'square';
            oscillator.start(now);
            oscillator.stop(now + 0.1);
            break;
            
        case 'explosion': // çˆ†ç‚¸ - å™ªéŸ³æ•ˆæœ
            oscillator.frequency.setValueAtTime(150, now);
            oscillator.frequency.exponentialRampToValueAtTime(50, now + 0.4);
            gainNode.gain.setValueAtTime(0.4, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            oscillator.type = 'sawtooth';
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            break;
            
        case 'cheer': // åº†ç¥ - æ¬¢å¿«çš„æ—‹å¾‹
            [523, 659, 784, 1047].forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.15, now + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.2);
                osc.start(now + i * 0.1);
                osc.stop(now + i * 0.1 + 0.2);
            });
            return; // å¤šä¸ªæŒ¯è¡å™¨ï¼Œæå‰è¿”å›
            
        case 'fail': // å¤±è´¥ - æ‚²ä¼¤çš„ä¸‹é™éŸ³
            [392, 349, 294, 262].forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.2, now + i * 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.3);
                osc.type = 'sine';
                osc.start(now + i * 0.15);
                osc.stop(now + i * 0.15 + 0.3);
            });
            return;
            
        case 'click': // ç‚¹å‡»æŒ‰é’® - è½»å¿«çš„ç‚¹å‡»éŸ³
            oscillator.frequency.setValueAtTime(600, now);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            oscillator.start(now);
            oscillator.stop(now + 0.05);
            break;
    }
}

// è®¡ç®—æ€ªå…½ç§»åŠ¨è·ç¦»ï¼Œç¡®ä¿è‡³å°‘æœ‰400pxçš„ç§»åŠ¨ç©ºé—´
const monsterDistance = Math.max(400, window.innerWidth - 150);

const monsters = [
    { img: "/static/images/pvz/monster1.png", speed: monsterDistance / (15 * 60), hitsNeeded: 1 }, // æ€ªå…½1éœ€è¦ç­”å¯¹1é¢˜
    { img: "/static/images/pvz/monster2.png", speed: monsterDistance / (15 * 60), hitsNeeded: 2 }, // æ€ªå…½2éœ€è¦ç­”å¯¹2é¢˜
    { img: "/static/images/pvz/monster3.png", speed: monsterDistance / (15 * 60), hitsNeeded: 3 }, // æ€ªå…½3éœ€è¦ç­”å¯¹3é¢˜
];

let currentMonster = null;
let monsterX = Math.max(400, window.innerWidth - 150);
let moving = true;
let monsterHits = 0; // å½“å‰æ€ªå…½å·²è¢«å‡»ä¸­æ¬¡æ•°

// ç”Ÿæˆéšæœºé¢˜åº“ï¼ˆ100ä»¥å†…åŠ å‡æ³•ï¼‰
function generateQuestions(count = 10) {
    const newQuestions = [];
    for (let i = 0; i < count; i++) {
        const isAddition = Math.random() > 0.5;
        let num1, num2, answer;
        
        if (isAddition) {
            num1 = Math.floor(Math.random() * 90) + 1; // 1-90
            num2 = Math.floor(Math.random() * (100 - num1)); // ç¡®ä¿å’Œä¸è¶…è¿‡100
            answer = num1 + num2;
        } else {
            num1 = Math.floor(Math.random() * 100) + 1; // 1-100
            num2 = Math.floor(Math.random() * num1); // ç¡®ä¿ç»“æœä¸ºæ­£æ•°
            answer = num1 - num2;
        }
        
        const operator = isAddition ? "+" : "-";
        const question = `${num1} ${operator} ${num2} = ?`;
        
        // ç”Ÿæˆ3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const wrongAnswers = new Set();
        while (wrongAnswers.size < 3) {
            let wrong = answer + Math.floor(Math.random() * 21) - 10; // Â±10èŒƒå›´å†…
            if (wrong !== answer && wrong >= 0 && wrong <= 100) {
                wrongAnswers.add(wrong);
            }
        }
        
        // åˆå¹¶ç­”æ¡ˆå¹¶æ‰“ä¹±
        const allAnswers = [answer, ...Array.from(wrongAnswers)];
        const shuffled = allAnswers.sort(() => Math.random() - 0.5);
        const rightIndex = shuffled.indexOf(answer);
        
        newQuestions.push({
            q: question,
            opts: shuffled.map(String),
            right: rightIndex
        });
    }
    return newQuestions;
}

let questions = generateQuestions(10);
let qi = 0;
let score = 0;
let correctStreak = 0;

function loadQuestion() {
    const qData = questions[qi];
    document.getElementById("questionBox").innerText = qData.q;

    let answers = document.getElementById("answers");
    answers.innerHTML = "";

    qData.opts.forEach((op, idx) => {
        let btn = document.createElement("div");
        btn.className = "ans-btn";
        btn.innerText = op;
        btn.onclick = () => checkAnswer(idx);
        answers.appendChild(btn);
    });
}

// åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
function loadNextQuestion() {
    qi++;
    if (qi >= questions.length) {
        // é¢˜ç›®ç”¨å®Œäº†ï¼Œç”Ÿæˆæ–°é¢˜åº“
        questions = generateQuestions(10);
        qi = 0;
    }
    loadQuestion();
}

// åˆ›å»ºæ€ªå…½
function spawnMonster() {
    // æŒ‰é¡ºåºå¾ªç¯ç”Ÿæˆæ€ªå…½ï¼ˆ1->2->3->1->2->3...ï¼‰
    let monsterIndex = qi % monsters.length;
    let m = monsters[monsterIndex];

    const img = document.createElement("img");
    img.src = m.img;
    img.className = "monster";
    img.style.left = monsterX + "px";
    img.style.top = "0";
    img.style.bottom = "0";

    img.dataset.speed = m.speed;
    img.dataset.hitsNeeded = m.hitsNeeded;
    img.dataset.currentHits = 0;

    document.getElementById("game").appendChild(img);
    currentMonster = img;
    monsterHits = 0; // é‡ç½®å‡»ä¸­æ¬¡æ•°

    moving = true;
    requestAnimationFrame(moveMonster);
}

// ç§»åŠ¨æ€ªå…½
function moveMonster() {
    if (!moving || !currentMonster) return;

    monsterX -= currentMonster.dataset.speed;

    currentMonster.style.left = monsterX + "px";

    if (monsterX < 180) {
        const playerDino = document.getElementById('playerDino');
        playerDino.className = 'cry';
        showEmotion('ğŸ˜­');
    }

    if (monsterX < 80) {
        moving = false;
        
        // å°æé¾™è¢«åƒæ‰åŠ¨ç”»
        const playerDino = document.getElementById('playerDino');
        playerDino.className = 'eaten';
        showEmotion('ğŸ’€');
        
        // å¤±è´¥éŸ³æ•ˆ
        playSound('fail');
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºå¤±è´¥ä¿¡æ¯
        setTimeout(() => {
            alert(`âŒ æ¸¸æˆå¤±è´¥ï¼šæé¾™è¢«åƒæ‰äº†ï¼\n\næœ¬å±€å¾—åˆ†: ${score}åˆ†\nç­”å¯¹é¢˜æ•°: ${qi}é¢˜`);
            resetGame();
        }, 1500);
        return;
    }

    requestAnimationFrame(moveMonster);
}

// å‘å°„å­å¼¹ï¼ˆç­”å¯¹åç›´æ¥å‡»ä¸­æ€ªå…½ï¼‰
function fireBullet(target, startX, startY) {
    // å‘å°„éŸ³æ•ˆ
    playSound('shoot');
    
    // å¢åŠ å‡»ä¸­æ¬¡æ•°
    monsterHits++;
    const hitsNeeded = parseInt(target.dataset.hitsNeeded);
    
    // åˆ›å»ºå‡»ä¸­ç‰¹æ•ˆ
    createHitEffect(target);
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å‡»æ€æ‰€éœ€æ¬¡æ•°
    if (monsterHits >= hitsNeeded) {
        // å‡»æ€æ€ªå…½
        killMonster(target);
    } else {
        // æœªå‡»æ€ï¼Œæ˜¾ç¤ºå‰©ä½™æ¬¡æ•°æç¤º
        showHitsRemaining(target, hitsNeeded - monsterHits);
        
        // æ€ªå…½åé€€50pxï¼Œä½†ä¸è¶…è¿‡å±å¹•æœ€å³ä¾§
        const maxX = Math.max(400, window.innerWidth - 150);
        monsterX = Math.min(monsterX + 50, maxX);
        target.style.left = monsterX + 'px';
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
        loadNextQuestion();
    }
}

// åˆ›å»ºå‡»ä¸­ç‰¹æ•ˆ
function createHitEffect(monster) {
    const rect = monster.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    // åˆ›å»ºå°å‹çˆ†ç‚¸ç²’å­
    for (let i = 0; i < 10; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'absolute';
        particle.style.width = '8px';
        particle.style.height = '8px';
        particle.style.borderRadius = '50%';
        particle.style.background = ['#FFD700', '#FFA500'][Math.floor(Math.random() * 2)];
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.zIndex = '15';
        particle.style.pointerEvents = 'none';
        
        const angle = (Math.PI * 2 * i) / 10;
        const velocity = 30 + Math.random() * 30;
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity;
        
        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');
        particle.style.animation = 'fireworkAnim 0.5s ease-out forwards';
        
        document.getElementById('game').appendChild(particle);
        
        setTimeout(() => particle.remove(), 500);
    }
}

// æ˜¾ç¤ºå‰©ä½™å‡»ä¸­æ¬¡æ•°
function showHitsRemaining(monster, remaining) {
    const rect = monster.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    const hintText = document.createElement('div');
    hintText.textContent = `è¿˜éœ€ ${remaining} æ¬¡ï¼`;
    hintText.style.position = 'absolute';
    hintText.style.left = centerX + 'px';
    hintText.style.top = (centerY - 50) + 'px';
    hintText.style.transform = 'translateX(-50%)';
    hintText.style.fontSize = '28px';
    hintText.style.fontWeight = 'bold';
    hintText.style.color = '#FF6B6B';
    hintText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.8)';
    hintText.style.zIndex = '20';
    hintText.style.animation = 'emotionPop 0.8s ease-out';
    hintText.style.pointerEvents = 'none';
    
    document.getElementById('game').appendChild(hintText);
    
    setTimeout(() => hintText.remove(), 800);
}

// å‡»æ€æ€ªå…½
function killMonster(monster) {
    moving = false;
    
    // çˆ†ç‚¸éŸ³æ•ˆ
    playSound('explosion');

    monster.style.animation = "explode 0.6s forwards";
    
    // åˆ›å»ºçˆ†ç‚¸ç²’å­
    createExplosion(monster);

    setTimeout(() => monster.remove(), 500);

    setTimeout(() => nextQuestion(), 600);
}

function createExplosion(monster) {
    const rect = monster.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'absolute';
        particle.style.width = '10px';
        particle.style.height = '10px';
        particle.style.borderRadius = '50%';
        particle.style.background = ['#FF6B6B', '#FFD700', '#FF8C00', '#FF4500'][Math.floor(Math.random() * 4)];
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.zIndex = '15';
        particle.style.pointerEvents = 'none';
        
        const angle = (Math.PI * 2 * i) / 30;
        const velocity = 100 + Math.random() * 100;
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity;
        
        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');
        particle.style.animation = 'fireworkAnim 0.8s ease-out forwards';
        
        document.getElementById('game').appendChild(particle);
        
        setTimeout(() => particle.remove(), 800);
    }
}

function checkAnswer(idx) {
    const qData = questions[qi];
    const playerDino = document.getElementById('playerDino');
    
    // ç‚¹å‡»éŸ³æ•ˆ
    playSound('click');
    
    if (idx === qData.right) {
        // æ­£ç¡®ç­”æ¡ˆéŸ³æ•ˆ
        playSound('correct');
        
        // æ­£ç¡®ç­”æ¡ˆ
        correctStreak++;
        const points = 10 + (correctStreak - 1) * 5; // è¿å‡»å¥–åŠ±
        score += points;
        updateScore();
        
        // å°æé¾™æ¬¢å‘¼
        playerDino.className = 'cheer';
        showEmotion('ğŸ˜„');
        createFireworks();
        
        // è·å–ç‚¹å‡»æŒ‰é’®çš„ä½ç½®
        const answerBtns = document.querySelectorAll('.ans-btn');
        const clickedBtn = answerBtns[idx];
        const btnRect = clickedBtn.getBoundingClientRect();
        clickedBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        clickedBtn.style.color = 'white';

        fireBullet(currentMonster, btnRect.left, btnRect.top + btnRect.height / 2);
        
        setTimeout(() => {
            playerDino.className = '';
        }, 2400);
    } else {
        // é”™è¯¯ç­”æ¡ˆéŸ³æ•ˆ
        playSound('wrong');
        
        // é”™è¯¯ç­”æ¡ˆ
        correctStreak = 0;
        score = Math.max(0, score - 5);
        updateScore();
        
        // å°æé¾™ææƒ§
        playerDino.className = 'fear';
        showEmotion('ğŸ˜±');
        
        // æŒ‰é’®éœ‡åŠ¨æ•ˆæœ
        const answerBtns = document.querySelectorAll('.ans-btn');
        const clickedBtn = answerBtns[idx];
        clickedBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        clickedBtn.style.color = 'white';
        
        setTimeout(() => {
            clickedBtn.style.background = '';
            clickedBtn.style.color = '';
        }, 500);
        
        // é”™è¯¯åˆ™æ€ªå…½åŠ é€Ÿ
        currentMonster.dataset.speed *= 1.5;
        
        setTimeout(() => {
            playerDino.className = '';
        }, 1500);
    }
}

function updateScore() {
    document.getElementById('score').textContent = score;
}

function showEmotion(emoji) {
    const playerDino = document.getElementById('playerDino');
    const emotion = document.createElement('div');
    emotion.className = 'emotion';
    emotion.textContent = emoji;
    playerDino.appendChild(emotion);
    
    setTimeout(() => emotion.remove(), 1000);
}

function createFireworks() {
    const fireEffect = document.getElementById('fireEffect');
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FF69B4'];
    
    for (let i = 0; i < 20; i++) {
        setTimeout(() => {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = '150px';
            firework.style.bottom = '40%';
            firework.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            const angle = (Math.PI * 2 * i) / 20;
            const distance = 100 + Math.random() * 50;
            firework.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            firework.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            
            fireEffect.appendChild(firework);
            
            setTimeout(() => firework.remove(), 1000);
        }, i * 50);
    }
}

function nextQuestion() {
    qi++;
    if (qi >= questions.length) {
        const playerDino = document.getElementById('playerDino');
        playerDino.className = 'cheer';
        showEmotion('ğŸ‰');
        
        // èƒœåˆ©éŸ³æ•ˆ
        playSound('cheer');
        
        setTimeout(() => {
            alert(`ğŸ‰ æ­å–œå…¨éƒ¨ç­”å¯¹ï¼\n\næœ€ç»ˆå¾—åˆ†: ${score}åˆ†\nç­”å¯¹é¢˜æ•°: ${questions.length}é¢˜`);
            resetGame();
        }, 500);
        return;
    }
    monsterX = Math.max(400, window.innerWidth - 150);
    loadQuestion();
    spawnMonster();
}

// é‡ç½®æ¸¸æˆ
function resetGame() {
    // æ¸…é™¤å½“å‰æ€ªå…½
    if (currentMonster) {
        currentMonster.remove();
        currentMonster = null;
    }
    
    // æ¸…é™¤æ‰€æœ‰å­å¼¹å’Œç²’å­
    document.querySelectorAll('.bullet').forEach(b => b.remove());
    document.querySelectorAll('.firework').forEach(f => f.remove());
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    questions = generateQuestions(10);
    qi = 0;
    score = 0;
    correctStreak = 0;
    updateScore();
    monsterX = Math.max(400, window.innerWidth - 150);
    moving = false;
    
    // é‡ç½®å°æé¾™çŠ¶æ€
    const playerDino = document.getElementById('playerDino');
    playerDino.className = '';
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    loadQuestion();
    spawnMonster();
}

// åˆå§‹åŒ–
loadQuestion();
spawnMonster();

// ç»‘å®šé‡ç½®æŒ‰é’®
document.getElementById("resetBtn").onclick = () => {
    playSound('click');
    if (confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå¹¶ç”Ÿæˆæ–°é¢˜ç›®å—ï¼Ÿ")) {
        resetGame();
    }
};

// éŸ³æ•ˆå¼€å…³æŒ‰é’®
document.getElementById("soundToggle").onclick = () => {
    soundEnabled = !soundEnabled;
    const btn = document.getElementById("soundToggle");
    btn.textContent = soundEnabled ? "ğŸ”Š éŸ³æ•ˆ" : "ğŸ”‡ é™éŸ³";
    playSound('click');
};
</script>
</body>
</html>
