<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æé¾™æ™ºç›Šç­”é¢˜æ¸¸æˆ Demo</title>
<style>
    body {
        margin: 0;
        font-family: "Comic Sans MS", sans-serif;
        background: #b9e8ff;
        overflow: hidden;
    }
    #game {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: url('/static/images/pvz/backgroud.png');
        background-size: cover;
        background-position: center;
        overflow: hidden;
    }
    #game::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: inherit;
        opacity: 0.3;
        z-index: 0;
    }
    .monster {
        position: absolute;
        width: auto;
        height: 100vh;
        transition: transform 0.2s;
        z-index: 10;
    }
    @keyframes fly {
        from { transform: translateX(-50px) translateY(0); opacity: 1; }
        to { transform: translateX(100px) translateY(-50px) rotate(90deg); opacity: 0; }
    }
    @keyframes explode {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5) rotate(10deg); opacity: 0.7; }
        100% { transform: scale(2) rotate(20deg); opacity: 0; }
    }
    #answers {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 20;
    }
    .ans-btn {
        padding: 15px 25px;
        background: #fff;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        border: 3px solid #333;
        transition: 0.2s;
    }
    .ans-btn:hover {
        background: #ffe08a;
    }
    .bullet {
        position: absolute;
        width: 60px;
        height: 60px;
        background: url('/static/images/pvz/bullet.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 15;
        transition: none;
        pointer-events: none;
        border: 2px solid red;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    #questionBox {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 32px;
        background: rgba(255,255,255,0.8);
        padding: 10px 30px;
        border-radius: 15px;
        border: 3px solid #444;
        z-index: 20;
    }
</style>
</head>
<body>

<div id="game">
    <div id="questionBox"></div>
    <div id="answers"></div>
</div>

<script>
const monsters = [
    { img: "/static/images/pvz/monster1.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
    { img: "/static/images/pvz/monster2.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
    { img: "/static/images/pvz/monster3.png", speed: (window.innerWidth - 150) / (10 * 60) }, // 10ç§’
];

let currentMonster = null;
let monsterX = window.innerWidth - 150;
let moving = true;

// ç¤ºä¾‹é¢˜åº“
const questions = [
    { q: "3 + 4 = ?", opts: ["5", "7", "9", "6"], right: 1 },
    { q: "8 - 3 = ?", opts: ["6", "5", "4", "3"], right: 1 },
    { q: "2 Ã— 6 = ?", opts: ["10", "11", "12", "14"], right: 2 },
];
let qi = 0;

function loadQuestion() {
    const qData = questions[qi];
    document.getElementById("questionBox").innerText = qData.q;

    let answers = document.getElementById("answers");
    answers.innerHTML = "";

    qData.opts.forEach((op, idx) => {
        let btn = document.createElement("div");
        btn.className = "ans-btn";
        btn.innerText = op;
        btn.onclick = () => checkAnswer(idx);
        answers.appendChild(btn);
    });
}

// åˆ›å»ºæ€ªå…½
function spawnMonster() {
    let m = monsters[Math.floor(Math.random() * monsters.length)];

    const img = document.createElement("img");
    img.src = m.img;
    img.className = "monster";
    img.style.left = monsterX + "px";
    img.style.top = "0";
    img.style.bottom = "0";

    img.dataset.speed = m.speed;

    document.getElementById("game").appendChild(img);
    currentMonster = img;

    moving = true;
    requestAnimationFrame(moveMonster);
}

// ç§»åŠ¨æ€ªå…½
function moveMonster() {
    if (!moving || !currentMonster) return;

    monsterX -= currentMonster.dataset.speed;

    currentMonster.style.left = monsterX + "px";

    if (monsterX < 80) {
        alert("âŒ æ¸¸æˆå¤±è´¥ï¼šæé¾™åƒæ‰äº†è›‹ï¼");
        location.reload();
        return;
    }

    requestAnimationFrame(moveMonster);
}

// å‘å°„å­å¼¹
function fireBullet(target, startX, startY) {
    const bullet = document.createElement("div");
    bullet.className = "bullet";

    // è°ƒæ•´èµ·å§‹ä½ç½®ï¼Œè®©å­å¼¹å±…ä¸­
    bullet.style.left = (startX - 30) + "px"; // å‡å»å­å¼¹å®½åº¦çš„ä¸€åŠ
    bullet.style.top = (startY - 30) + "px"; // å‡å»å­å¼¹é«˜åº¦çš„ä¸€åŠ

    document.getElementById("game").appendChild(bullet);

    console.log("å­å¼¹åˆ›å»º:", { startX, startY });

    // è·å–æ€ªå…½çš„ä½ç½®
    const monsterRect = target.getBoundingClientRect();
    const targetX = monsterRect.left + monsterRect.width / 2 - 30; // å±…ä¸­
    const targetY = monsterRect.top + monsterRect.height / 2 - 30; // å±…ä¸­

    console.log("ç›®æ ‡ä½ç½®:", { targetX, targetY });

    const distanceX = targetX - (startX - 30);
    const distanceY = targetY - (startY - 30);
    const duration = 120; // 120å¸§ï¼Œçº¦2ç§’ï¼Œè®©ç§»åŠ¨æ›´å®¹æ˜“çœ‹åˆ°
    const stepX = distanceX / duration;
    const stepY = distanceY / duration;

    let frame = 0;
    let bx = startX - 30;
    let by = startY - 30;

    const timer = setInterval(() => {
        frame++;
        bx += stepX;
        by += stepY;
        bullet.style.left = bx + "px";
        bullet.style.top = by + "px";

        if (frame % 20 === 0) {
            console.log("å­å¼¹ä½ç½®:", { bx, by, frame });
        }

        // åˆ°è¾¾ç›®æ ‡ä½ç½®æˆ–è¶…è¿‡æ—¶é—´
        if (frame >= duration) {
            clearInterval(timer);
            console.log("å­å¼¹åˆ°è¾¾ç›®æ ‡");
            bullet.remove();
            killMonster(target);
        }

    }, 16); // çº¦60fps
}

// å‡»æ€æ€ªå…½
function killMonster(monster) {
    moving = false;

    monster.style.animation = "explode 0.6s forwards";

    setTimeout(() => monster.remove(), 500);

    setTimeout(() => nextQuestion(), 600);
}

function checkAnswer(idx) {
    const qData = questions[qi];
    if (idx === qData.right) {
        // è·å–ç‚¹å‡»æŒ‰é’®çš„ä½ç½®
        const answerBtns = document.querySelectorAll('.ans-btn');
        const clickedBtn = answerBtns[idx];
        const btnRect = clickedBtn.getBoundingClientRect();

        fireBullet(currentMonster, btnRect.left, btnRect.top + btnRect.height / 2);
    } else {
        // é”™è¯¯åˆ™æ€ªå…½åŠ é€Ÿ
        currentMonster.dataset.speed *= 1.5;
    }
}

function nextQuestion() {
    qi++;
    if (qi >= questions.length) {
        alert("ğŸ‰ æ­å–œå…¨éƒ¨ç­”å¯¹ï¼");
        location.reload();
        return;
    }
    monsterX = window.innerWidth - 150;
    loadQuestion();
    spawnMonster();
}

// åˆå§‹åŒ–
loadQuestion();
spawnMonster();
</script>
</body>
</html>
